/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
#ifndef TIMER_H
#define TIMER_H

#include <stdbool.h>
#include <stdint.h>

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
#define TIMER_FLAG_ENABLED  0x0001
#define TIMER_FLAG_PERIODIC 0x0002
#define TIMER_FLAG_ASYNC    0x0004
#define TIMER_FLAG_COUNTUP  0x0008
#define TIMER_FLAG_EXPIRED  0x0010
#define TIMER_FLAG_OVERFLOW 0x0020
#define TIMER_FLAG_CALLBACK 0x0040

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
#define timer_enabled(t) (((t)->flags & TIMER_FLAG_ENABLED) ? true : false)

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
#define timer_periodic(t) (((t)->flags & TIMER_FLAG_PERIODIC) ? true : false)

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
#define timer_async(t) (((t)->flags & TIMER_FLAG_ASYNC) ? true : false)

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
#define timer_countup(t) (((t)->flags & TIMER_FLAG_COUNTUP) ? true : false)

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
#define timer_callback(t) (((t)->flags & TIMER_FLAG_CALLBACK) ? true : false)

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
typedef struct timer
{
   struct timer* next;
   volatile uint16_t flags;

   struct
   {
      volatile uint32_t current;
      uint32_t reset;

   } value;

   void (*fx)(struct timer*);

} timer_t;

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
void timer_add(timer_t* timer, uint16_t flags, uint32_t value, void (*fx)(timer_t*));

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
bool timer_expired(timer_t* timer, bool clear);

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
bool timer_overflowed(timer_t* timer, bool clear);

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
void timer_enable(timer_t* timer, bool enable);

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
void timer_expire(timer_t* timer);

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
void timer_reset(timer_t* timer);

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
uint32_t timer_get(timer_t* timer, uint32_t* reset);

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
void timer_set(timer_t* timer, uint32_t current, uint32_t reset);

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
void timer_update();

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
void timer_init();

#endif
