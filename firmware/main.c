/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
#include <avr/interrupt.h>
#include <avr/io.h>
#include <avr/sleep.h>
#include <ctype.h>
#include <stdio.h>
#include <stdlib.h>
#include <util/delay.h>
#include <xc.h>
#include "main.h"
#include "timer.h"
#include "uart.h"

#if 0
/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
FUSES =
{
   .WDTCFG = PERIOD_2KCLK_gc,
   .BODCFG = LVL_BODLEVEL0_gc | ACTIVE_ENABLED_gc | SLEEP_ENABLED_gc,
   .OSCCFG = FREQSEL_20MHZ_gc,
   .TCD0CFG = 0x00,
   .SYSCFG0 = CRCSRC_NOCRC_gc | RSTPINCFG_GPIO_gc,
   .SYSCFG1 = SUT_64MS_gc
};
#endif

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
static struct
{
   struct
   {
      timer_t main;

   } timer;

} runtime;

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
static int _fputc(char c, FILE* stream)
{
   if (c == '\n')
      uart_tx('\r');

   uart_tx(c);

   return 0;
}

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
static FILE uart_stdout = FDEV_SETUP_STREAM(_fputc, NULL, _FDEV_SETUP_WRITE);

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
static void sys_init()
{
   // F_CPU = 20MHz / 4
   //_PROTECTED_WRITE(CLKCTRL.MCLKCTRLB, CLKCTRL_PDIV_4X_gc | CLKCTRL_PEN_bm);
   _PROTECTED_WRITE(CLKCTRL.MCLKCTRLB, 0);

   set_sleep_mode(SLEEP_MODE_IDLE);

   stdout = &uart_stdout;
   stderr = &uart_stdout;
}

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
void console_tx(int c)
{
   _fputc(c, stdout);
}

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
int console_rx()
{
   int c = uart_rx(false);

   if (c == '\r')
      c = '\n';

   if (isprint(c) || (c == '\n'))
      console_tx(c);

   return c;
}

/*******************************************************************************************************************
 *
 *******************************************************************************************************************/
int main()
{
   sys_init();
   uart_init(9600);
   timer_init();

    _delay_ms(100);

   printf("\n!BOOT %02X\n", RSTCTRL.RSTFR);
   RSTCTRL.RSTFR = RSTCTRL.RSTFR;

   timer_add(&runtime.timer.main, TIMER_FLAG_PERIODIC | TIMER_FLAG_ENABLED, 1000, NULL);

   sei();

   for (;;)
   {
      timer_update();

      if (timer_expired(&runtime.timer.main, true))
         printf("Hello, Gus!");

      sleep_enable();
      sleep_cpu();
      sleep_disable();
   }

   return 0;
}
